

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>biogeme.biogeme &mdash; Biogeme 3.2.14 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=0b773b56"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Biogeme
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../code/toml.html">Configuration parameters</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../code/native_draws.html">Native draws</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../code/biogeme.html">.biogeme module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Biogeme</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">biogeme.biogeme</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for biogeme.biogeme</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the main Biogeme class</span>

<span class="sd">:author: Michel Bierlaire</span>
<span class="sd">:date: Tue Mar 26 16:45:15 2019</span>

<span class="sd">It combines the database and the model specification.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">difflib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cythonbiogeme.cythonbiogeme</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.database</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">db</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.filenames</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.optimization</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">opt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.results</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">res</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.tools.derivatives</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">biogeme.tools.unique_ids</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.configuration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.deprecated</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">deprecated</span><span class="p">,</span>
    <span class="n">deprecated_parameters</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.dict_of_formulas</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_validity</span><span class="p">,</span> <span class="n">get_expression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BiogemeError</span><span class="p">,</span> <span class="n">ValueOutOfRange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IdManager</span><span class="p">,</span>
    <span class="n">Expression</span><span class="p">,</span>
    <span class="n">ExpressionOrNumeric</span><span class="p">,</span>
    <span class="n">log</span><span class="p">,</span>
    <span class="n">bioMultSum</span><span class="p">,</span>
    <span class="n">SelectedExpressionsIterator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.function_output</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">FunctionOutput</span><span class="p">,</span>
    <span class="n">BiogemeFunctionOutput</span><span class="p">,</span>
    <span class="n">BiogemeFunctionOutputSmartOutputProxy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.negative_likelihood</span><span class="w"> </span><span class="kn">import</span> <span class="n">NegativeLikelihood</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">biogeme.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Parameters</span><span class="p">,</span>
    <span class="n">DEFAULT_FILE_NAME</span> <span class="k">as</span> <span class="n">DEFAULT_PARAMETER_FILE_NAME</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">DEFAULT_MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;biogemeModelDefaultName&#39;</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="OldNewParamTuple">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.OldNewParamTuple">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OldNewParamTuple</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">old</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">new</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">section</span><span class="p">:</span> <span class="nb">str</span></div>



<div class="viewcode-block" id="BIOGEME">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BIOGEME</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class that combines the database and the model</span>
<span class="sd">        specification.</span>

<span class="sd">    It works in two modes: estimation and simulation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">properties_initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@deprecated_parameters</span><span class="p">(</span>
        <span class="n">obsolete_params</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;suggestScales&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;numberOfThreads&#39;</span><span class="p">:</span> <span class="s1">&#39;number_of_threads&#39;</span><span class="p">,</span>
            <span class="s1">&#39;numberOfDraws&#39;</span><span class="p">:</span> <span class="s1">&#39;number_of_draws&#39;</span><span class="p">,</span>
            <span class="s1">&#39;missingData&#39;</span><span class="p">:</span> <span class="s1">&#39;missing_data&#39;</span><span class="p">,</span>
            <span class="s1">&#39;parameter_file&#39;</span><span class="p">:</span> <span class="s1">&#39;parameters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;userNotes&#39;</span><span class="p">:</span> <span class="s1">&#39;user_notes&#39;</span><span class="p">,</span>
            <span class="s1">&#39;generateHtml&#39;</span><span class="p">:</span> <span class="s1">&#39;generate_html&#39;</span><span class="p">,</span>
            <span class="s1">&#39;saveIterations&#39;</span><span class="p">:</span> <span class="s1">&#39;save_iterations&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed_param&#39;</span><span class="p">:</span> <span class="s1">&#39;seed&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">Database</span><span class="p">,</span>
        <span class="n">formulas</span><span class="p">:</span> <span class="n">Expression</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">],</span>
        <span class="n">user_notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Parameters</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_audit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        :param database: choice data.</span>
<span class="sd">        :type database: :class:`biogeme.database.Database`</span>

<span class="sd">        :param formulas: expression or dictionary of expressions that</span>
<span class="sd">             define the model specification.  The concept is that each</span>
<span class="sd">             expression is applied to each entry of the database. The</span>
<span class="sd">             keys of the dictionary allow to provide a name to each</span>
<span class="sd">             formula.  In the estimation mode, two formulas are</span>
<span class="sd">             needed, with the keys &#39;log_like&#39; and &#39;weight&#39;. If only one</span>
<span class="sd">             formula is provided, it is associated with the label</span>
<span class="sd">             &#39;log_like&#39;. If no formula is labeled &#39;weight&#39;, the weight</span>
<span class="sd">             of each piece of data is supposed to be 1.0. In the</span>
<span class="sd">             simulation mode, the labels of each formula are used as</span>
<span class="sd">             labels of the resulting database.</span>
<span class="sd">        :type formulas: :class:`biogeme.expressions.Expression`, or</span>
<span class="sd">                        dict(:class:`biogeme.expressions.Expression`)</span>

<span class="sd">        :param user_notes: these notes will be included in the report file.</span>
<span class="sd">        :type user_notes: str</span>

<span class="sd">        :param parameters: name of the .toml file where the parameters are read, or Parameters object containing</span>
<span class="sd">        the parameters. If None, the default values of the parameters are used.</span>


<span class="sd">        :raise BiogemeError: an audit of the formulas is performed.</span>
<span class="sd">           If a formula has issues, an error is detected and an</span>
<span class="sd">           exception is raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Biogeme parameters provided by the user.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="p">:</span> <span class="n">Parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="p">:</span> <span class="n">Parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">DEFAULT_PARAMETER_FILE_NAME</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Argument &quot;parameters&quot; is of wrong type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">file_name</span>

        <span class="c1"># We allow the values of the parameters to be set with arguments</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Check for name clashes and create properties dynamically</span>
        <span class="n">properties_to_define_automatically</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">parameter_names</span>
        <span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">BIOGEME</span><span class="o">.</span><span class="n">properties_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_properties</span><span class="p">(</span><span class="n">properties_to_define_automatically</span><span class="p">)</span>
            <span class="n">BIOGEME</span><span class="o">.</span><span class="n">properties_initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skip_audit</span> <span class="o">=</span> <span class="n">skip_audit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function_parameters</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_audit</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">list_of_errors</span><span class="p">,</span> <span class="n">list_of_warnings</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_audit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">list_of_warnings</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_warnings</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">list_of_errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_like_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;log_like&#39;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Keywords used for the name of the loglikelihood formula.</span>
<span class="sd">        Default: &#39;log_like&#39;&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_like_valid_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;log_like&#39;</span><span class="p">,</span> <span class="s1">&#39;loglike&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight_name</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keyword used for the name of the weight formula. Default: &#39;weight&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight_valid_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="n">DEFAULT_MODEL_NAME</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of the model. Default: &#39;biogemeModelDefaultName&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; ``monte_carlo`` is True if one of the expressions involves a</span>
<span class="sd">        Monte-Carlo integration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;seed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">short_names</span><span class="p">:</span> <span class="n">biogeme</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">ModelNames</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expression </span><span class="si">{</span><span class="n">formulas</span><span class="si">}</span><span class="s2"> is not of type &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;biogeme.expressions.Expression. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;It is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">formulas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">:</span> <span class="n">Expression</span> <span class="o">=</span> <span class="n">formulas</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Object of type :class:`biogeme.expressions.Expression`</span>
<span class="sd">            calculating the formula for the loglikelihood</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
                <span class="n">check_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">check_panel_trajectory</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">check_variables</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error in the loglikelihood function. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Some variables are not inside PanelLikelihoodTrajectory: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_variables</span><span class="si">}</span><span class="s2"> .&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;If the database is organized as panel data, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;all variables must be used inside a &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;PanelLikelihoodTrajectory. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;If it is not consistent with your model, generate a flat &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;version of the data using the function &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`generateFlatPanelDataframe`.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Object of type :class:`biogeme.expressions.Expression`</span>
<span class="sd">            calculating the weight of each observation in the</span>
<span class="sd">            sample.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like_name</span><span class="p">:</span> <span class="n">formulas</span><span class="p">})</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Dictionary containing Biogeme formulas of type</span>
<span class="sd">            :class:`biogeme.expressions.Expression`.</span>
<span class="sd">            The keys are the names of the formulas.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span> <span class="o">=</span> <span class="n">formulas</span>
            <span class="c1"># Verify the validity of the formulas</span>
            <span class="n">check_validity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">:</span> <span class="n">Expression</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span>
                <span class="n">dict_of_formulas</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span> <span class="n">valid_keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like_valid_names</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span>
                <span class="n">dict_of_formulas</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span> <span class="n">valid_keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_valid_names</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">missing_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;missing_data&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">missing_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_notes</span> <span class="o">=</span> <span class="n">user_notes</span>  <span class="c1">#: User notes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastSample</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; keeps track of the sample of data used to calculate the</span>
<span class="sd">        stochastic gradient / hessian</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initLogLike</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: Init value of the likelihood function</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nullLogLike</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: Log likelihood of the null model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_database_for_formula</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_audit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_audit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_id_manager</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theC</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">pyBiogeme</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">number_of_free_betas</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setPanel</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setDataMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">individualMap</span><span class="p">)</span>
        <span class="c1"># Transfer the data to the C++ formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setMissingData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_data</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_draws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setDraws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">theDraws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawsProcessingTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Time needed to generate the draws. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_id_manager</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loglikeSignatures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Internal signature of the formula for the</span>
<span class="sd">            loglikelihood.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setExpressions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglikeSignatures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_threads</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weightSignatures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; Internal signature of the formula for the weight.&quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setExpressions</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loglikeSignatures</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_threads</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weightSignatures</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_time</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Time needed to calculate the bootstrap standard errors&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: Results of the bootstrap calculation.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizationMessages</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Information provided by the optimization algorithm</span>
<span class="sd">        after completion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; True if the algorithm has converged</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bestIteration</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: Store the best iteration found so far.</span>

<div class="viewcode-block" id="BIOGEME.from_configuration">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.from_configuration">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_configuration</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">config_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expression</span><span class="p">:</span> <span class="n">ExpressionOrNumeric</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">Database</span><span class="p">,</span>
        <span class="n">user_notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Parameters</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_audit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BIOGEME</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the Biogeme object corresponding to the</span>
<span class="sd">        configuration of a multiple expression</span>

<span class="sd">        :param config_id: identifier of the configuration</span>
<span class="sd">        :type config_id: strftime</span>

<span class="sd">        :param expression: multiple expression containing all the catalogs.</span>
<span class="sd">        :type expression: biogeme.expression.Expression</span>

<span class="sd">        :param database: database to be passed to the Biogeme object</span>
<span class="sd">        :type database: biogeme.database.Database</span>

<span class="sd">        :param user_notes: these notes will be included in the report file.</span>
<span class="sd">        :type user_notes: str</span>

<span class="sd">        :param parameters: object with the parameters</span>

<span class="sd">        :param skip_audit: if True, no auditing is performed.</span>
<span class="sd">        :type skip_audit: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expression</span><span class="o">.</span><span class="n">set_of_configurations</span><span class="p">():</span>
            <span class="c1"># We verify that the configuration is valid</span>
            <span class="n">the_set</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">get_string_id</span><span class="p">()</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">set_of_configurations</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">the_set</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No configuration found in the expression&quot;</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">the_set</span><span class="p">:</span>
                <span class="n">close_matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">config_id</span><span class="p">,</span> <span class="n">the_set</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">close_matches</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unknown configuration: [</span><span class="si">{</span><span class="n">config_id</span><span class="si">}</span><span class="s2">]. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Did you mean [</span><span class="si">{</span><span class="n">close_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]?&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unknown configuration: </span><span class="si">{</span><span class="n">config_id</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">the_configuration</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">config_id</span><span class="p">)</span>
        <span class="n">expression</span><span class="o">.</span><span class="n">configure_catalogs</span><span class="p">(</span><span class="n">the_configuration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_notes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_notes</span> <span class="o">=</span> <span class="n">the_configuration</span><span class="o">.</span><span class="n">get_html</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">formulas</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span>
            <span class="n">user_notes</span><span class="o">=</span><span class="n">user_notes</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">skip_audit</span><span class="o">=</span><span class="n">skip_audit</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.is_model_complex">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.is_model_complex">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_model_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the model is potentially complex to estimate&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">requires_draws</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">embed_expression</span><span class="p">(</span><span class="s1">&#39;Integrate&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BIOGEME.argument_warning">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.argument_warning">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">argument_warning</span><span class="p">(</span><span class="n">old_new_tuple</span><span class="p">:</span> <span class="n">OldNewParamTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Displays a deprecation warning when parameters are provided</span>
<span class="sd">        as arguments.&quot;&quot;&quot;</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The use of argument </span><span class="si">{</span><span class="n">old_new_tuple</span><span class="o">.</span><span class="n">old</span><span class="si">}</span><span class="s2"> in the constructor of the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;BIOGEME object is deprecated and will be removed in future &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;versions of Biogeme. Instead, define parameter </span><span class="si">{</span><span class="n">old_new_tuple</span><span class="o">.</span><span class="n">new</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in section </span><span class="si">{</span><span class="n">old_new_tuple</span><span class="o">.</span><span class="n">section</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;of the .toml parameter file. The default file name is &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DEFAULT_PARAMETER_FILE_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For backward compatibility&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span>

<div class="viewcode-block" id="BIOGEME.initialize_properties">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.initialize_properties">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The name &#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39; already exists in the class.&quot;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">make_getter</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_setter</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.make_getter">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.make_getter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_getter</span><span class="p">(</span><span class="n">param_name</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">getter</span></div>


<div class="viewcode-block" id="BIOGEME.make_setter">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.make_setter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_setter</span><span class="p">(</span><span class="n">param_name</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">setter</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">numberOfThreads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of threads used for parallel computing. Default: the number</span>
<span class="sd">        of available CPU.</span>
<span class="sd">        Maintained for backward compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Obsolete syntax. Use number_of_threads instead of numberOfThreads&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_threads</span>

    <span class="nd">@numberOfThreads</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">numberOfThreads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Obsolete syntax. Use number_of_threads instead of numberOfThreads&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_threads</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_of_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of threads used for parallel computing. Default: the number</span>
<span class="sd">        of available CPU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbr_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;number_of_threads&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="k">if</span> <span class="n">nbr_threads</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">nbr_threads</span>

    <span class="nd">@number_of_threads</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_of_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;number_of_threads&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s2">&quot;MultiThreading&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">numberOfDraws</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of draws for Monte-Carlo integration.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Obsolete syntax. Use number_of_draws instead of numberOfDraws&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span>

    <span class="nd">@numberOfDraws</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">numberOfDraws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Obsolete syntax. Use number_of_draws instead of numberOfDraws&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generatePickle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Boolean variable, True if the PICKLE file with the results must</span>
<span class="sd">        be generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Obsolete syntax. Use generate_pickle instead of generatePickle&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;generate_pickle&quot;</span><span class="p">)</span>

    <span class="nd">@generatePickle</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generatePickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Obsolete syntax. Use generate_pickle instead of generatePickle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biogeme_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;generate_pickle&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s2">&quot;Output&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BIOGEME.reset_id_manager">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.reset_id_manager">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_id_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all the ids of the elementary expression in the formulas&quot;&quot;&quot;</span>
        <span class="c1"># First, we reset the IDs</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">set_id_manager</span><span class="p">(</span><span class="n">id_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Second, we calculate a new set of IDs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span> <span class="o">=</span> <span class="n">IdManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">set_id_manager</span><span class="p">(</span><span class="n">id_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_function_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the parameters for the function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tolerance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="s2">&quot;steptol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">steptol</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_algorithm_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the parameters for the algorithms&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="o">==</span> <span class="s1">&#39;automatic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_model_complex</span><span class="p">():</span>
                <span class="n">info_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;As the model is rather complex, we cancel the calculation of second derivatives. If you want &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;to control the parameters, change the name of the algorithm in the TOML file from &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;automatic&quot; to &quot;simple_bounds&quot;&#39;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;proportionAnalyticalHessian&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;infeasibleConjugateGradient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">infeasible_cg</span><span class="p">,</span>
                    <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_radius</span><span class="p">,</span>
                    <span class="s2">&quot;enlargingFactor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlarging_factor</span><span class="p">,</span>
                    <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;As the model is not too complex, we activate the calculation of second derivatives. If you want &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;to change it, change the name of the algorithm in the TOML file from &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;automatic&quot; to &quot;simple_bounds&quot;&#39;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;proportionAnalyticalHessian&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;infeasibleConjugateGradient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">infeasible_cg</span><span class="p">,</span>
                    <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_radius</span><span class="p">,</span>
                    <span class="s2">&quot;enlargingFactor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlarging_factor</span><span class="p">,</span>
                    <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="o">==</span> <span class="s2">&quot;simple_bounds&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;proportionAnalyticalHessian&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">second_derivatives</span><span class="p">,</span>
                <span class="s2">&quot;infeasibleConjugateGradient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">infeasible_cg</span><span class="p">,</span>
                <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_radius</span><span class="p">,</span>
                <span class="s2">&quot;enlargingFactor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlarging_factor</span><span class="p">,</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;simple_bounds_newton&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simple_bounds_BFGS&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;infeasibleConjugateGradient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">infeasible_cg</span><span class="p">,</span>
                <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_radius</span><span class="p">,</span>
                <span class="s2">&quot;enlargingFactor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlarging_factor</span><span class="p">,</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TR-newton&quot;</span><span class="p">,</span> <span class="s2">&quot;TR-BFGS&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;dogleg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">,</span>
                <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_radius</span><span class="p">,</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LS-newton&quot;</span><span class="p">,</span> <span class="s2">&quot;LS-BFGS&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_iterations_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: The name of the file where the iterations are saved.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">.iter&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_audit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Each expression provides an audit function, that verifies its</span>
<span class="sd">        validity. Each formula is audited, and the list of errors</span>
<span class="sd">        and warnings reported.</span>

<span class="sd">        :raise BiogemeError: if the formula has issues, an error is</span>
<span class="sd">                             detected and an exception is raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_of_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list_of_warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">check_draws</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">check_draws</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_draws</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The following draws are defined outside the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;MonteCarlo operator: </span><span class="si">{</span><span class="n">check_draws</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">list_of_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">check_rv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">check_rv</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_rv</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The following random variables are defined &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;outside the Integrate operator: </span><span class="si">{</span><span class="n">check_rv</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">list_of_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">err</span><span class="p">,</span> <span class="n">war</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
            <span class="n">list_of_errors</span> <span class="o">+=</span> <span class="n">err</span>
            <span class="n">list_of_warnings</span> <span class="o">+=</span> <span class="n">war</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">get_value_c</span><span class="p">(</span>
                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prepare_ids</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">s_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">()</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">s_size</span> <span class="o">/</span> <span class="n">total</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">the_warning</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The sum of the weights (</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">) is different from &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;the sample size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">()</span><span class="si">}</span><span class="s2">). &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiply the weights by </span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s2"> to reconcile the two.&quot;</span>
                <span class="p">)</span>
                <span class="n">list_of_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">list_of_warnings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_warnings</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">list_of_errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_draws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_draws</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If Monte-Carlo integration is involved in one of the formulas, this</span>
<span class="sd">           function instructs the database to generate the draws.</span>

<span class="sd">        Args:</span>
<span class="sd">            number_of_draws: self explanatory (int)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Draws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">requires_draws</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">generate_draws</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">draw_types</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">draws</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="n">number_of_draws</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_database_for_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Rebuild the map for panel data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">build_panel_map</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">free_beta_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the names of the parameters that must be estimated</span>

<span class="sd">        :return: list of names of the parameters</span>
<span class="sd">        :rtype: list(str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">freeBetaNames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Obsolete syntax. Use free_beta_names instead of freeBetaNames&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span>

<div class="viewcode-block" id="BIOGEME.number_unknown_parameters">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.number_unknown_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_unknown_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of parameters that must be estimated</span>

<span class="sd">        :return: number of parameters</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.get_beta_values">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.get_beta_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_beta_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dict with the initial values of Beta. Typically</span>
<span class="sd">            useful for simulation.</span>

<span class="sd">        :return: dict with the initial values of the Beta</span>
<span class="sd">        :rtype: dict(str: float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_betas</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_betas</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_betas</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">all_betas</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">formula</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">all_betas</span></div>


<div class="viewcode-block" id="BIOGEME.get_bounds_on_beta">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.get_bounds_on_beta">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bounds_on_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the bounds on the parameter as defined by the user.</span>

<span class="sd">        :param beta_name: name of the parameter</span>
<span class="sd">        :type beta_name: string</span>
<span class="sd">        :return: lower bound, upper bound</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        :raises BiogemeError: if the name of the parameter is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">beta_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown parameter </span><span class="si">{</span><span class="n">beta_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


<div class="viewcode-block" id="BIOGEME.getBoundsOnBeta">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.getBoundsOnBeta">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">get_bounds_on_beta</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">getBoundsOnBeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.calculate_null_loglikelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculate_null_loglikelihood">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_null_loglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avail</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ExpressionOrNumeric</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the log likelihood of the null model that predicts equal</span>
<span class="sd">        probability for each alternative</span>

<span class="sd">        :param avail: list of expressions to evaluate the availability</span>
<span class="sd">                      conditions for each alternative. If 1 is provided, it is always available.</span>
<span class="sd">        :type avail: list of :class:`biogeme.expressions.Expression`</span>

<span class="sd">        :return: value of the log likelihood</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">bioMultSum</span><span class="p">(</span><span class="n">avail</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nullLogLike</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">get_value_c</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prepare_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullLogLike</span></div>


<div class="viewcode-block" id="BIOGEME.calculateNullLoglikelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculateNullLoglikelihood">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">calculate_null_loglikelihood</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculateNullLoglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avail</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ExpressionOrNumeric</span><span class="p">]):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.calculate_init_likelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculate_init_likelihood">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_init_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the value of the log likelihood function</span>

<span class="sd">        The default values of the parameters are used.</span>

<span class="sd">        :return: value of the log likelihood.</span>
<span class="sd">        :rtype: float.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Value of the loglikelihood for the default values of the parameters.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initLogLike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initLogLike</span></div>


<div class="viewcode-block" id="BIOGEME.calculateInitLikelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculateInitLikelihood">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">calculate_init_likelihood</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculateInitLikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.calculate_likelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculate_likelihood">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_likelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">scaled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the value of the log likelihood function</span>

<span class="sd">        :param x: vector of values for the parameters.</span>
<span class="sd">        :type x: list(float)</span>

<span class="sd">        :param scaled: if True, the value is divided by the number of</span>
<span class="sd">                       observations used to calculate it. In this</span>
<span class="sd">                       case, the values with different sample sizes</span>
<span class="sd">                       are comparable. Default: True</span>
<span class="sd">        :type scaled: bool</span>

<span class="sd">        :param batch: if not None, calculates the likelihood on a</span>
<span class="sd">                       random sample of the data. The value of the</span>
<span class="sd">                       parameter must be strictly between 0 and 1, and</span>
<span class="sd">                       represents the share of the data that will be</span>
<span class="sd">                       used. Default: None</span>
<span class="sd">        :type batch: float</span>

<span class="sd">        :return: the calculated value of the log likelihood</span>
<span class="sd">        :rtype: float.</span>

<span class="sd">        :raises ValueError: if the length of the list x is incorrect.</span>

<span class="sd">        :raises BiogemeError: if calculation with batch is requested</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;Calculation with batch not yet implemented&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Input vector must be of length &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_database_for_formula</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">calculateLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">fixed_betas_values</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Log likelihood (N = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">()</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s2">10.7g</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="BIOGEME.calculateLikelihood">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculateLikelihood">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">calculate_likelihood</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculateLikelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scaled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.report_array">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.report_array">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">with_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reports the entries of the array up to the maximum number</span>

<span class="sd">        :param array: array to report</span>
<span class="sd">        :type array: numpy.array</span>

<span class="sd">        :param with_names: if True, the names of the parameters are included</span>
<span class="sd">        :type with_names: bool</span>

<span class="sd">        :return: string reporting the values</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_number_parameters_to_report</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_beta_names</span>
            <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="n">length</span><span class="p">],</span> <span class="n">array</span><span class="p">[:</span><span class="n">length</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">report</span>
        <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">array</span><span class="p">[:</span><span class="n">length</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">report</span></div>


<div class="viewcode-block" id="BIOGEME.calculate_likelihood_and_derivatives">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculate_likelihood_and_derivatives">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_likelihood_and_derivatives</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">scaled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">hessian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">bhhh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BiogemeFunctionOutputSmartOutputProxy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the value of the log likelihood function</span>
<span class="sd">        and its derivatives.</span>

<span class="sd">        :param x: vector of values for the parameters.</span>
<span class="sd">        :type x: list(float)</span>

<span class="sd">        :param scaled: if True, the results are divided by the number of</span>
<span class="sd">            observations.</span>
<span class="sd">        :type scaled: bool</span>

<span class="sd">        :param hessian: if True, the hessian is calculated. Default: False.</span>
<span class="sd">        :type hessian: bool</span>

<span class="sd">        :param bhhh: if True, the BHHH matrix is calculated. Default: False.</span>
<span class="sd">        :type bhhh: bool</span>

<span class="sd">        :param batch: if not None, calculates the likelihood on a</span>
<span class="sd">                       random sample of the data. The value of the</span>
<span class="sd">                       parameter must be strictly between 0 and 1, and</span>
<span class="sd">                       represents the share of the data that will be</span>
<span class="sd">                       used. Default: None</span>
<span class="sd">        :type batch: float</span>


<span class="sd">        :return: f, g, h, bh where</span>

<span class="sd">                - f is the value of the function (float)</span>
<span class="sd">                - g is the gradient (numpy.array)</span>
<span class="sd">                - h is the hessian (numpy.array)</span>
<span class="sd">                - bh is the BHHH matrix (numpy.array)</span>

<span class="sd">        :rtype: tuple  float, numpy.array, numpy.array, numpy.array</span>

<span class="sd">        :raises ValueError: if the length of the list x is incorrect</span>

<span class="sd">        :raises BiogemeError: if the norm of the gradient is not finite, an</span>
<span class="sd">            error is raised.</span>
<span class="sd">        :raises BiogemeError: if calculatation with batch is requested</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;Calculation with batch not yet implemented&quot;</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">number_of_free_betas</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Input vector must be of length &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">number_of_free_betas</span><span class="si">}</span><span class="s2"> and not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_database_for_formula</span><span class="p">()</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">bh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">bh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">calculateLikelihoodAndDerivatives</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">fixed_betas_values</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">g</span><span class="p">,</span>
            <span class="n">h</span><span class="p">,</span>
            <span class="n">bh</span><span class="p">,</span>
            <span class="n">hessian</span><span class="p">,</span>
            <span class="n">bhhh</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">hmsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hessian</span><span class="p">:</span>
            <span class="n">hmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hessian norm:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="si">:</span><span class="s2">10.1g</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">bhhhmsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bhhh</span><span class="p">:</span>
            <span class="n">bhhhmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BHHH norm:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span><span class="si">:</span><span class="s2">10.1g</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gradnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Log likelihood (N = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">()</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s2">10.7g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Gradient norm: </span><span class="si">{</span><span class="n">gradnorm</span><span class="si">:</span><span class="s2">10.1g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">hmsg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bhhhmsg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">gradnorm</span><span class="p">):</span>
            <span class="n">report_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">report_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_array</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">with_names</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The norm of the gradient at </span><span class="si">{</span><span class="n">report_x</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">gradnorm</span><span class="si">}</span><span class="s2">: g=</span><span class="si">{</span><span class="n">report_g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_iterations</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestIteration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bestIteration</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestIteration</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations_file_name</span><span class="p">(),</span>
                    <span class="s2">&quot;w&quot;</span><span class="p">,</span>
                    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">pf</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">file</span><span class="o">=</span><span class="n">pf</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">sample_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample size is </span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">BiogemeFunctionOutput</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="n">f</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">gradient</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">hessian</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">bhhh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">BiogemeFunctionOutputSmartOutputProxy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">BiogemeFunctionOutput</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
            <span class="n">gradient</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">g</span><span class="p">),</span>
            <span class="n">hessian</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
            <span class="n">bhhh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bh</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">BiogemeFunctionOutputSmartOutputProxy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.calculateLikelihoodAndDerivatives">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.calculateLikelihoodAndDerivatives">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">calculate_likelihood_and_derivatives</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculateLikelihoodAndDerivatives</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">scaled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">hessian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">bhhh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionOutput</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.likelihood_finite_difference_hessian">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.likelihood_finite_difference_hessian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">likelihood_finite_difference_hessian</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the hessian of the log likelihood function using finite</span>
<span class="sd">        differences.</span>

<span class="sd">        May be useful when the analytical hessian has numerical issues.</span>

<span class="sd">        :param x: vector of values for the parameters.</span>
<span class="sd">        :type x: list(float)</span>

<span class="sd">        :return: finite differences approximation of the hessian.</span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">        :raises ValueError: if the length of the list x is incorrect</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">the_function</span><span class="p">(</span><span class="n">the_x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionOutput</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood_and_derivatives</span><span class="p">(</span>
                <span class="n">the_x</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bhhh</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">biogeme</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">derivatives</span><span class="o">.</span><span class="n">findiff_h</span><span class="p">(</span><span class="n">the_function</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="BIOGEME.likelihoodFiniteDifferenceHessian">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.likelihoodFiniteDifferenceHessian">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">likelihood_finite_difference_hessian</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">likelihoodFiniteDifferenceHessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.check_derivatives">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.check_derivatives">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifies the implementation of the derivatives.</span>

<span class="sd">        It compares the analytical version with the finite differences</span>
<span class="sd">        approximation.</span>

<span class="sd">        :param beta: vector of values for the parameters.</span>
<span class="sd">        :type beta: list(float)</span>

<span class="sd">        :param verbose: if True, the comparisons are reported. Default: False.</span>
<span class="sd">        :type verbose: bool</span>

<span class="sd">        :rtype: tuple.</span>

<span class="sd">        :return: f, g, h, gdiff, hdiff where</span>

<span class="sd">            - f is the value of the function,</span>
<span class="sd">            - g is the analytical gradient,</span>
<span class="sd">            - h is the analytical hessian,</span>
<span class="sd">            - gdiff is the difference between the analytical and the</span>
<span class="sd">              finite differences gradient,</span>
<span class="sd">            - hdiff is the difference between the analytical and the</span>
<span class="sd">              finite differences hessian,</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">the_function</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionOutput</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Wrapper function to use tools.checkDerivatives&quot;&quot;&quot;</span>
            <span class="n">the_function_output</span><span class="p">:</span> <span class="n">FunctionOutput</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood_and_derivatives</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bhhh</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">the_function_output</span>

        <span class="k">return</span> <span class="n">biogeme</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">derivatives</span><span class="o">.</span><span class="n">check_derivatives</span><span class="p">(</span>
            <span class="n">the_function</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.checkDerivatives">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.checkDerivatives">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">check_derivatives</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">checkDerivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_saved_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads the values of the parameters from a text file where each line</span>
<span class="sd">        has the form name_of_beta = value_of_beta, and use these values in all</span>
<span class="sd">        formulas.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations_file_name</span><span class="p">()</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">ell</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">betas</span><span class="p">[</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter values restored from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot read file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">. Statement is ignored.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BIOGEME.set_random_init_values">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.set_random_init_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_random_init_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modifies the initial values of the parameters in all formulas,</span>
<span class="sd">        using randomly generated values. The value is drawn from a</span>
<span class="sd">        uniform distribution on the interval defined by the</span>
<span class="sd">        bounds.</span>

<span class="sd">        :param default_bound: If the upper bound is missing, it is</span>
<span class="sd">            replaced by this value. If the lower bound is missing, it is</span>
<span class="sd">            replaced by the opposite of this value. Default: 100.</span>
<span class="sd">        :type default_bound: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">random_betas</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=-</span><span class="n">default_bound</span> <span class="k">if</span> <span class="n">beta</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="n">default_bound</span> <span class="k">if</span> <span class="n">beta</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta</span><span class="o">.</span><span class="n">ub</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">expressions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">random_betas</span><span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.setRandomInitValues">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.setRandomInitValues">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">set_random_init_values</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setRandomInitValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.change_init_values">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.change_init_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_init_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">betas</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modifies the initial values of the parameters in all formula</span>

<span class="sd">        :param betas: dictionary where the keys are the names of the</span>
<span class="sd">                      parameters, and the values are the new value for</span>
<span class="sd">                      the parameters.</span>
<span class="sd">        :type betas: dict(string:float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">betas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="BIOGEME.estimate_catalog">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.estimate_catalog">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_catalog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selected_configurations</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Configuration</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quick_estimate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">recycle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">run_bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate all or selected versions of a model with Catalog&#39;s,</span>
<span class="sd">        corresponding to multiple specifications.</span>

<span class="sd">        :param selected_configurations: set of configurations. If</span>
<span class="sd">            None, all configurations are considered.</span>
<span class="sd">        :type selected_configurations: set(biogeme.pareto.SetElement)</span>

<span class="sd">        :param quick_estimate: if True, the final statistics are not calculated.</span>
<span class="sd">        :type quick_estimate: bool</span>

<span class="sd">        :param recycle: if True, the results are read from the pickle</span>
<span class="sd">            file, if it exists. If False, the estimation is performed.</span>
<span class="sd">        :type recycle: bool</span>

<span class="sd">        :param run_bootstrap: if True, bootstrapping is applied.</span>
<span class="sd">        :type run_bootstrap: bool</span>

<span class="sd">        :return: object containing the estimation results associated</span>
<span class="sd">            with the name of each specification, as well as a</span>
<span class="sd">            description of each configuration</span>
<span class="sd">        :rtype: dict(str: bioResults)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_names</span> <span class="o">=</span> <span class="n">biogeme</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">ModelNames</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;No log likelihood function has been specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selected_configurations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number_of_specifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">number_of_multiple_expressions</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimating </span><span class="si">{</span><span class="n">number_of_specifications</span><span class="si">}</span><span class="s2"> models.&quot;</span><span class="p">)</span>
            <span class="c1">#            logger.debug(f&#39;{number_of_specifications=}&#39;)</span>
            <span class="c1"># logger.info(f&#39;{self.maximum_number_catalog_expressions=}&#39;)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">number_of_specifications</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="n">number_of_specifications</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_number_catalog_expressions</span>
            <span class="p">):</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;There are too many [</span><span class="si">{</span><span class="n">number_of_specifications</span><span class="si">}</span><span class="s2">] different &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;specifications for the log likelihood function. This is &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;above the maximum number: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_number_catalog_expressions</span><span class="si">}</span><span class="s2">. Simplify &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;the specification, change the value of the parameter &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;maximum_number_catalog_expressions, or consider using &quot;</span>
                    <span class="sa">f</span><span class="s1">&#39;the AssistedSpecification object in the &quot;biogeme.assisted&quot; &#39;</span>
                    <span class="sa">f</span><span class="s2">&quot;module.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ValueOutOfRange</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

            <span class="n">the_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_iterator</span> <span class="o">=</span> <span class="n">SelectedExpressionsIterator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">,</span> <span class="n">selected_configurations</span>
            <span class="p">)</span>
        <span class="n">configurations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">the_iterator</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">current_configuration</span><span class="p">()</span>
            <span class="n">config_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_string_id</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">BIOGEME</span><span class="o">.</span><span class="n">from_configuration</span><span class="p">(</span>
                <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span>
            <span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_names</span><span class="p">(</span><span class="n">config_id</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">generate_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html</span>
            <span class="n">b</span><span class="o">.</span><span class="n">generate_pickle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pickle</span>
            <span class="k">if</span> <span class="n">quick_estimate</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">quick_estimate</span><span class="p">(</span><span class="n">recycle</span><span class="o">=</span><span class="n">recycle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">recycle</span><span class="o">=</span><span class="n">recycle</span><span class="p">,</span> <span class="n">run_bootstrap</span><span class="o">=</span><span class="n">run_bootstrap</span><span class="p">)</span>

            <span class="n">configurations</span><span class="p">[</span><span class="n">config_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>

        <span class="k">return</span> <span class="n">configurations</span></div>


<div class="viewcode-block" id="BIOGEME.recycled_estimation">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.recycled_estimation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">recycled_estimation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">recycle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_bootstrap</span><span class="o">=</span><span class="n">run_bootstrap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="BIOGEME.estimate">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.estimate">[docs]</a>
    <span class="nd">@deprecated_parameters</span><span class="p">(</span><span class="n">obsolete_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span> <span class="s1">&#39;run_bootstrap&#39;</span><span class="p">})</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">recycle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">run_bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate the parameters of the model(s).</span>

<span class="sd">        :param recycle: if True, the results are read from the pickle</span>
<span class="sd">            file, if it exists. If False, the estimation is performed.</span>
<span class="sd">        :type recycle: bool</span>

<span class="sd">        :param run_bootstrap: if True, bootstrapping is applied.</span>
<span class="sd">        :type run_bootstrap: bool</span>

<span class="sd">        :return: object containing the estimation results.</span>
<span class="sd">        :rtype: biogeme.bioResults</span>

<span class="sd">        Example::</span>

<span class="sd">            # Create an instance of biogeme</span>
<span class="sd">            biogeme  = bio.BIOGEME(database, logprob)</span>

<span class="sd">            # Gives a name to the model</span>
<span class="sd">            biogeme.modelName = &#39;mymodel&#39;</span>

<span class="sd">            # Estimate the parameters</span>
<span class="sd">            results = biogeme.estimate()</span>

<span class="sd">        :raises BiogemeError: if no expression has been provided for the</span>
<span class="sd">            likelihood</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;No log likelihood function has been specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bootstrap&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Parameter &quot;bootstrap&quot; is deprecated. In order to perform &#39;</span>
                <span class="s2">&quot;bootstrapping, set parameter run_bootstrap=True in the estimate &quot;</span>
                <span class="s2">&quot;function, and specify the number of bootstrap draws in the &quot;</span>
                <span class="s2">&quot;biogeme.toml file [e.g. bootstrap_samples=100].&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algorithm&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameter &quot;optimization_algorithm&quot; in section &quot;[Estimation]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algo_parameters&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algo_parameters&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameters &quot;max_iterations&quot; and &quot;tolerance&quot; in section &#39;</span>
                <span class="s1">&#39;&quot;[SimpleBounds]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algoParameters&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algoParameters&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameters &quot;max_iterations&quot; and &quot;tolerance&quot; in section &#39;</span>
                <span class="s1">&#39;&quot;[SimpleBounds]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span> <span class="o">==</span> <span class="n">DEFAULT_MODEL_NAME</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You have not defined a name for the model. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The output .py are named from the model name. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The default is [</span><span class="si">{</span><span class="n">DEFAULT_MODEL_NAME</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_function_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">recycle</span><span class="p">:</span>
            <span class="n">pickle_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_of_type</span><span class="p">(</span><span class="s2">&quot;pickle&quot;</span><span class="p">)</span>
            <span class="n">pickle_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pickle_files</span><span class="p">:</span>
                <span class="n">pickle_to_read</span> <span class="o">=</span> <span class="n">pickle_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Several pickle .py are available for &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;this model: </span><span class="si">{</span><span class="n">pickle_files</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">pickle_to_read</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;is used to load the results.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">(</span>
                    <span class="n">pickle_file</span><span class="o">=</span><span class="n">pickle_to_read</span><span class="p">,</span>
                    <span class="n">identification_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identification_threshold</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Estimation results read from </span><span class="si">{</span><span class="n">pickle_to_read</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;There is no guarantee that they correspond &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;to the specified model.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="n">warning_msg</span> <span class="o">=</span> <span class="s2">&quot;Recycling was requested, but no pickle file was found&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There is no parameter to estimate&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; in the formula: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_iterations</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;*** Initial values of the parameters are &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;obtained from the file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations_file_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_saved_iteration</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_init_likelihood</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bestIteration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1">#        yep.start(&#39;profile.out&#39;)</span>

        <span class="c1">#        yep.stop()</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">))</span>
        <span class="n">xstar</span><span class="p">,</span> <span class="n">optimization_messages</span><span class="p">,</span> <span class="n">convergence</span> <span class="o">=</span> <span class="n">output</span>
        <span class="c1"># Running time of the optimization algorithm</span>
        <span class="n">optimization_messages</span><span class="p">[</span><span class="s2">&quot;Optimization time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="c1"># Information provided by the optimization algorithm after completion.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizationMessages</span> <span class="o">=</span> <span class="n">optimization_messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>

        <span class="n">f_g_h_b</span><span class="p">:</span> <span class="n">BiogemeFunctionOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood_and_derivatives</span><span class="p">(</span>
            <span class="n">xstar</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bhhh</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_g_h_b</span><span class="o">.</span><span class="n">hessian</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Numerical problems in calculating &quot;</span>
                <span class="s2">&quot;the analytical hessian. Finite differences&quot;</span>
                <span class="s2">&quot; is tried instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
            <span class="n">fin_diff_hessian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_finite_difference_hessian</span><span class="p">(</span><span class="n">xstar</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_g_h_b</span><span class="o">.</span><span class="n">hessian</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Numerical problems with finite difference hessian as well.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_g_h_b</span> <span class="o">=</span> <span class="n">BiogemeFunctionOutput</span><span class="p">(</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">f_g_h_b</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
                    <span class="n">gradient</span><span class="o">=</span><span class="n">f_g_h_b</span><span class="o">.</span><span class="n">gradient</span><span class="p">,</span>
                    <span class="n">hessian</span><span class="o">=</span><span class="n">fin_diff_hessian</span><span class="p">,</span>
                    <span class="n">bhhh</span><span class="o">=</span><span class="n">f_g_h_b</span><span class="o">.</span><span class="n">bhhh</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># numpy array, of size B x K,</span>
        <span class="c1"># where</span>
        <span class="c1">#        - B is the number of bootstrap iterations</span>
        <span class="c1">#        - K is the number pf parameters to estimate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">run_bootstrap</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Re-estimate the model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_samples</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;times for bootstrapping&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xstar</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">current_logger_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span>
            <span class="c1"># Temporarily stop reporting log messages</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_samples</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sample_individual_map_with_replacement</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setDataMap</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sample_with_replacement</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="n">x_br</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">xstar</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_br</span>

            <span class="c1"># Time needed to generate the bootstrap results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">current_logger_level</span><span class="p">)</span>
        <span class="n">raw_results</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">RawResults</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">xstar</span><span class="p">,</span> <span class="n">f_g_h_b</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span>
        <span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">(</span>
            <span class="n">raw_results</span><span class="p">,</span>
            <span class="n">identification_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identification_threshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">estimated_betas</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">estimated_betas</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">algorithm_has_converged</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;It seems that the optimization algorithm did not converge. &#39;</span>
                <span class="s1">&#39;Therefore, the results may not correspond to the maximum &#39;</span>
                <span class="s1">&#39;likelihood estimator. Check the specification of the model, &#39;</span>
                <span class="s1">&#39;or the criteria for convergence of the algorithm.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">only_robust_stats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pickle</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">write_pickle</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="BIOGEME.quick_estimate">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.quick_estimate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">quick_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;| Estimate the parameters of the model. Same as estimate, where any</span>
<span class="sd">             extra calculation is skipped (init loglikelihood,</span>
<span class="sd">             t-statistics, etc.)</span>

<span class="sd">        :return: object containing the estimation results.</span>
<span class="sd">        :rtype: biogeme.results.bioResults</span>

<span class="sd">        Example::</span>

<span class="sd">            # Create an instance of biogeme</span>
<span class="sd">            biogeme  = bio.BIOGEME(database, logprob)</span>

<span class="sd">            # Gives a name to the model</span>
<span class="sd">            biogeme.modelName = &#39;mymodel&#39;</span>

<span class="sd">            # Estimate the parameters</span>
<span class="sd">            results = biogeme.quickEstimate()</span>

<span class="sd">        :raises BiogemeError: if no expression has been provided for the</span>
<span class="sd">            likelihood</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;No log likelihood function has been specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algorithm&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameter &quot;optimization_algorithm&quot; in section &quot;[Estimation]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algo_parameters&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algo_parameters&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameters &quot;max_iterations&quot; and &quot;tolerance&quot; in section &#39;</span>
                <span class="s1">&#39;&quot;[SimpleBounds]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algoParameters&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The parameter &quot;algoParameters&quot; is deprecated. Instead, define the &#39;</span>
                <span class="s1">&#39;parameters &quot;max_iterations&quot; and &quot;tolerance&quot; in section &#39;</span>
                <span class="s1">&#39;&quot;[SimpleBounds]&quot; &#39;</span>
                <span class="s2">&quot;of the TOML parameter file&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There is no parameter to estimate&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; in the formula: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_function_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm_parameters</span><span class="p">()</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1">#        yep.start(&#39;profile.out&#39;)</span>

        <span class="c1">#        yep.stop()</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">))</span>

        <span class="n">xstar</span><span class="p">,</span> <span class="n">optimization_messages</span><span class="p">,</span> <span class="n">convergence</span> <span class="o">=</span> <span class="n">output</span>
        <span class="c1"># Running time of the optimization algorithm</span>
        <span class="n">optimization_messages</span><span class="p">[</span><span class="s2">&quot;Optimization time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="c1"># Information provided by the optimization algorithm after completion.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizationMessages</span> <span class="o">=</span> <span class="n">optimization_messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood</span><span class="p">(</span><span class="n">xstar</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">f_g_h_b</span> <span class="o">=</span> <span class="n">BiogemeFunctionOutput</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">gradient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bhhh</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">raw_results</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">RawResults</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">xstar</span><span class="p">,</span>
            <span class="n">f_g_h_b</span><span class="p">,</span>
            <span class="n">bootstrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_results</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">(</span>
            <span class="n">raw_results</span><span class="p">,</span>
            <span class="n">identification_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identification_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">algorithm_has_converged</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;It seems that the optimization algorithm did not converge. &#39;</span>
                <span class="s1">&#39;Therefore, the results below may not correspond to the maximum &#39;</span>
                <span class="s1">&#39;likelihood estimator. Check the specification of the model, &#39;</span>
                <span class="s1">&#39;or the criteria for convergence of the algorithm.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="BIOGEME.quickEstimate">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.quickEstimate">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">quick_estimate</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">quickEstimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BIOGEME.validate">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.validate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">estimation_results</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">bioResults</span><span class="p">,</span>
        <span class="n">validation_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">EstimationValidation</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform out-of-sample validation.</span>

<span class="sd">        The function performs the following tasks:</span>

<span class="sd">          - each slice defines a validation set (the slice itself)</span>
<span class="sd">            and an estimation set (the rest of the data),</span>
<span class="sd">          - the model is re-estimated on the estimation set,</span>
<span class="sd">          - the estimated model is applied on the validation set,</span>
<span class="sd">          - the value of the log likelihood for each observation is reported.</span>

<span class="sd">        :param estimation_results: results of the model estimation based on the</span>
<span class="sd">            full data.</span>
<span class="sd">        :type estimation_results: biogeme.results.bioResults</span>

<span class="sd">        :param validation_data: list of estimation and validation data sets</span>
<span class="sd">        :type validation_data: list(tuple(pandas.DataFrame, pandas.DataFrame))</span>

<span class="sd">        :return: a list containing as many items as slices. Each item</span>
<span class="sd">                 is the result of the simulation on the validation set.</span>
<span class="sd">        :rtype: list(pandas.DataFrame)</span>

<span class="sd">        :raises BiogemeError: An error is raised if the database is structured</span>
<span class="sd">            as panel data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;Validation for panel data is not yet implemented&quot;</span><span class="p">)</span>

        <span class="n">keep_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>

        <span class="n">all_simulation_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validation_data</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># v[0] is the estimation data set</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="s2">&quot;Estimation data&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">estimation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">change_init_values</span><span class="p">(</span><span class="n">estimation_results</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">())</span>
            <span class="n">est_biogeme</span> <span class="o">=</span> <span class="n">BIOGEME</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">)</span>
            <span class="n">est_biogeme</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">_val_est_</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">est_biogeme</span><span class="o">.</span><span class="n">estimate</span><span class="p">()</span>
            <span class="n">simulate</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Loglikelihood&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="p">}</span>
            <span class="n">sim_biogeme</span> <span class="o">=</span> <span class="n">BIOGEME</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="s2">&quot;Validation data&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">validation</span><span class="p">),</span>
                <span class="n">simulate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sim_biogeme</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">_val_sim_</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">sim_result</span> <span class="o">=</span> <span class="n">sim_biogeme</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">())</span>
            <span class="n">all_simulation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">keep_database</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pickle</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s1">_validation&#39;</span>
            <span class="n">pickle_file_name</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">get_new_file_name</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_simulation_results</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation results saved in file </span><span class="si">{</span><span class="n">pickle_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_simulation_results</span></div>


<div class="viewcode-block" id="BIOGEME.optimize">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.optimize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">starting_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">opt</span><span class="o">.</span><span class="n">OptimizationResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calls the optimization algorithm. The function self.algorithm</span>
<span class="sd">        is called.</span>

<span class="sd">        :param starting_values: starting point for the algorithm</span>
<span class="sd">        :type starting_values: list(float)</span>

<span class="sd">        :return: x, messages</span>

<span class="sd">           - x is the solution generated by the algorithm,</span>
<span class="sd">           - messages is a dictionary describing several information about the</span>
<span class="sd">             algorithm</span>

<span class="sd">        :rtype: numpay.array, dict(str:object)</span>


<span class="sd">        :raises BiogemeError: an error is raised if no algorithm is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">requires_draws</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">warning_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The number of draws (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_draws</span><span class="si">}</span><span class="s1">) is low. The results may not be meaningful.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm_parameters</span><span class="p">()</span>
        <span class="n">the_function</span> <span class="o">=</span> <span class="n">NegativeLikelihood</span><span class="p">(</span>
            <span class="n">dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">number_of_free_betas</span><span class="p">,</span>
            <span class="n">like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood</span><span class="p">,</span>
            <span class="n">like_derivatives</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood_and_derivatives</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">starting_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">starting_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas_values</span><span class="p">)</span>

        <span class="n">algorithm_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;simple_bounds&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="o">==</span> <span class="s1">&#39;automatic&#39;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span>
        <span class="p">)</span>
        <span class="n">the_algorithm</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">algorithm_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">the_algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Algorithm </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_algorithm</span><span class="si">}</span><span class="s1"> is not found in the optimization package&#39;</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># logger.debug(&#39;&#39;.join(traceback.format_stack()))</span>
        <span class="n">variable_names</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_beta_names</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_number_parameters_to_report</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">the_algorithm</span><span class="p">(</span>
            <span class="n">fct</span><span class="o">=</span><span class="n">the_function</span><span class="p">,</span>
            <span class="n">init_betas</span><span class="o">=</span><span class="n">starting_values</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">variable_names</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algo_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="BIOGEME.beta_values_dict_to_list">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.beta_values_dict_to_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">beta_values_dict_to_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">beta_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transforms a dict with the names of the betas associated</span>
<span class="sd">            with their values, into a list consistent with the</span>
<span class="sd">            numbering of the ids.</span>

<span class="sd">        :param beta_dict: dict with the values of  the parameters</span>
<span class="sd">        :type beta_dict: dict(str: float)</span>

<span class="sd">        :raises BiogemeError: if the parameter is not a dict</span>

<span class="sd">        :raises BiogemeError: if a parameter is missing in the dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">beta_dict</span> <span class="o">|=</span> <span class="n">formula</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beta_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;A dictionary must be provided. &quot;</span>
                <span class="s2">&quot;It can be obtained from results.getBetaValues()&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">beta_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> not present in the model.&quot;</span><span class="p">)</span>

        <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">free_betas</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">beta_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Incomplete dict. The value of </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> is not provided.&quot;</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

            <span class="n">beta_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">beta_list</span></div>


<div class="viewcode-block" id="BIOGEME.simulate">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.simulate">[docs]</a>
    <span class="nd">@deprecated_parameters</span><span class="p">(</span><span class="n">obsolete_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;theBetaValues&#39;</span><span class="p">:</span> <span class="s1">&#39;the_beta_values&#39;</span><span class="p">})</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_beta_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the formulas to each row of the database.</span>

<span class="sd">        :param the_beta_values: values of the parameters to be used in</span>
<span class="sd">                the calculations. If None, the default values are</span>
<span class="sd">                used. Default: None.</span>
<span class="sd">        :type the_beta_values: dict(str, float)</span>

<span class="sd">        :return: a pandas data frame with the simulated value. Each</span>
<span class="sd">              row corresponds to a row in the database, and each</span>
<span class="sd">              column to a formula.</span>

<span class="sd">        :rtype: Pandas data frame</span>

<span class="sd">        Example::</span>

<span class="sd">              # Read the estimation results from a file</span>
<span class="sd">              results = res.bioResults(pickle_file = &#39;myModel.pickle&#39;)</span>
<span class="sd">              # Simulate the formulas using the nominal values</span>
<span class="sd">              simulatedValues = biogeme.simulate(beta_values)</span>

<span class="sd">        :raises BiogemeError: if the number of parameters is incorrect</span>

<span class="sd">        :raises BiogemeError: if theBetaValues is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">the_beta_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_beta_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beta_values</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Contrarily to previous versions of Biogeme, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;the values of Beta must &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;now be explicitly mentioned. If they have been estimated, they can be obtained from &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;results.getBetaValues(). If not, used the default values: </span><span class="si">{</span><span class="n">current_beta_values</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="n">beta_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_values_dict_to_list</span><span class="p">(</span><span class="n">the_beta_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">count_panel_trajectory_expressions</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">the_error</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;For panel data, the expression must &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;contain exactly one PanelLikelihoodTrajectory &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;operator. It contains </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="n">the_error</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">individualMap</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">formulas_signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">is_panel</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">build_panel_map</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">setDataMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">individualMap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">list_of_errors</span><span class="p">,</span> <span class="n">list_of_warnings</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">list_of_warnings</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_warnings</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">list_of_errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">BiogemeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_errors</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theC</span><span class="o">.</span><span class="n">simulateSeveralFormulas</span><span class="p">(</span>
            <span class="n">formulas_signature</span><span class="p">,</span>
            <span class="n">beta_values</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_manager</span><span class="o">.</span><span class="n">fixed_betas_values</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="BIOGEME.confidence_intervals">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">confidence_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">beta_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">interval_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence intervals on the simulated quantities</span>


<span class="sd">        :param beta_values: array of parameters values to be used in</span>
<span class="sd">               the calculations. Typically, it is a sample drawn from</span>
<span class="sd">               a distribution.</span>
<span class="sd">        :type beta_values: list(dict(str: float))</span>

<span class="sd">        :param interval_size: size of the reported confidence interval,</span>
<span class="sd">                    in percentage. If it is denoted by s, the interval</span>
<span class="sd">                    is calculated for the quantiles (1-s)/2 and</span>
<span class="sd">                    (1+s)/2. The default (0.9) corresponds to</span>
<span class="sd">                    quantiles for the confidence interval [0.05, 0.95].</span>
<span class="sd">        :type interval_size: float</span>

<span class="sd">        :return: two pandas data frames &#39;left&#39; and &#39;right&#39; with the</span>
<span class="sd">            same dimensions. Each row corresponds to a row in the</span>
<span class="sd">            database, and each column to a formula. &#39;left&#39; contains the</span>
<span class="sd">            left value of the confidence interval, and &#39;right&#39; the right</span>
<span class="sd">            value</span>

<span class="sd">            Example::</span>

<span class="sd">                # Read the estimation results from a file</span>
<span class="sd">                results = res.bioResults(pickle_file = &#39;myModel.pickle&#39;)</span>
<span class="sd">                # Retrieve the names of the betas parameters that have been</span>
<span class="sd">                # estimated</span>
<span class="sd">                betas = biogeme.freeBetaNames</span>

<span class="sd">                # Draw 100 realization of the distribution of the estimators</span>
<span class="sd">                b = results.getBetasForSensitivityAnalysis(betas, size = 100)</span>

<span class="sd">                # Simulate the formulas using the nominal values</span>
<span class="sd">                simulatedValues = biogeme.simulate(beta_values)</span>

<span class="sd">                # Calculate the confidence intervals for each formula</span>
<span class="sd">                left, right = biogeme.confidenceIntervals(b, 0.9)</span>

<span class="sd">        :rtype: tuple of two Pandas dataframes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beta_values</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">list_of_results</span> <span class="o">+=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">all_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">list_of_results</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">interval_size</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">all_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">all_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span></div>


<div class="viewcode-block" id="BIOGEME.confidenceIntervals">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.confidenceIntervals">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">confidence_intervals</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">confidenceIntervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">beta_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">interval_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">: database [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="BIOGEME.files_of_type">
<a class="viewcode-back" href="../../code/biogeme/biogeme.html#biogeme.biogeme.BIOGEME.files_of_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">files_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_files</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify the list of .py with a given extension in the</span>
<span class="sd">        local directory</span>

<span class="sd">        :param extension: extension of the requested .py (without</span>
<span class="sd">            the dot): &#39;pickle&#39;, or &#39;html&#39;</span>
<span class="sd">        :type extension: str</span>
<span class="sd">        :param all_files: if all_files is False, only .py containing</span>
<span class="sd">            the name of the model are identified. If all_files is</span>
<span class="sd">            True, all .py with the requested extension are</span>
<span class="sd">            identified.</span>
<span class="sd">        :type all_files: bool</span>

<span class="sd">        :return: list of .py with the requested extension.</span>
<span class="sd">        :rtype: list(str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">all_files</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s2">~*.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern1</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Michel Bierlaire.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>